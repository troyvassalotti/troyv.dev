/** @format */

const {EleventyServerless} = require("@11ty/eleventy");

// Explicit dependencies for the bundler from config file and global data.
// The file is generated by the Eleventy Serverless Bundler Plugin.
require("./eleventy-bundler-modules.js");

async function handler(event) {
	let elev = new EleventyServerless("ondemand", {
		path: new URL(event.rawUrl).pathname,
		query: event.queryStringParameters,
		functionsDir: "./netlify/functions/",
	});

	try {
		let [page] = await elev.getOutput();

		return {
			statusCode: 200,
			headers: {
				"Content-Type": "text/html; charset=UTF-8",
			},
			body: page.content,
			ttl: 1800,
		};
	} catch (error) {
		// Only console log for matching serverless paths
		// (otherwise youâ€™ll see a bunch of BrowserSync 404s for non-dynamic URLs during --serve)
		if (elev.isServerlessUrl(event.path)) {
			console.log("Serverless Error:", error);
		}

		return {
			statusCode: error.httpStatusCode || 500,
			body: JSON.stringify(
				{
					error: error.message,
				},
				null,
				2,
			),
		};
	}
}

const {builder} = require("@netlify/functions");
exports.handler = builder(handler);
